<PermissionsScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        
        canvas.before:
            Color:
                rgba: 0.95, 0.95, 1, 1  # Fondo celeste claro
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(100)
            spacing: dp(10)
            
            # Logo (string vacío - no se mostrará)
            Image:
                source: app.logo_image
                size_hint_y: None
                height: dp(50)
                allow_stretch: True
                keep_ratio: True
            
            Label:
                text: "Permisos de Android"
                font_size: '20sp'
                bold: True
                color: 0.1, 0.2, 0.5, 1
                size_hint_y: None
                height: dp(30)
                halign: 'center'
        
        # Estado de permisos
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(120)
            spacing: dp(10)
            padding: dp(15)
            
            canvas.before:
                Color:
                    rgba: (0.9, 1, 0.9, 1) if root.permissions_granted else (1, 0.95, 0.9, 1)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10,]
            
            Label:
                text: root.permissions_message
                font_size: '16sp'
                color: (0.1, 0.6, 0.1, 1) if root.permissions_granted else (0.8, 0.4, 0, 1)
                size_hint_y: None
                height: dp(30)
                halign: 'center'
                text_size: self.width - dp(20), None
            
            # Barra de progreso
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: dp(50)
                spacing: dp(5)
                
                Label:
                    text: f"{root.total_count - root.missing_count} / {root.total_count} permisos otorgados"
                    font_size: '14sp'
                    color: 0.3, 0.3, 0.3, 1
                    size_hint_y: None
                    height: dp(20)
                    halign: 'center'
                
                # Barra de progreso visual
                BoxLayout:
                    size_hint_y: None
                    height: dp(20)
                    padding: dp(5), 0
                    
                    Widget:
                        canvas.before:
                            Color:
                                rgba: 0.8, 0.8, 0.8, 1
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [5,]
                            Color:
                                rgba: (0.2, 0.8, 0.2, 1) if root.permissions_granted else (0.9, 0.6, 0.1, 1)
                            RoundedRectangle:
                                pos: self.pos
                                size: (self.width * (root.total_count - root.missing_count) / max(root.total_count, 1), self.height)
                                radius: [5,]
        
        # Lista de permisos faltantes (solo si hay)
        ScrollView:
            size_hint_y: 0.4
            opacity: 0 if root.permissions_granted else 1
            disabled: root.permissions_granted
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(5)
                padding: dp(10)
                
                Label:
                    text: "Permisos faltantes:" if root.missing_count > 0 else ""
                    font_size: '14sp'
                    bold: True
                    color: 0.5, 0.2, 0.2, 1
                    size_hint_y: None
                    height: dp(25) if root.missing_count > 0 else 0
                    halign: 'left'
                    text_size: self.width, None
                
                # Generar labels para cada permiso faltante
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(25) * len(root.missing_permissions)
                    spacing: dp(3)
                    
                    # Esto es un placeholder - en realidad necesitarías usar RecycleView
                    # para listas dinámicas, pero para simplificar usamos esto
                    Label:
                        text: "\\n".join([f"• {root.get_permission_display_name(p)}" for p in root.missing_permissions])
                        font_size: '12sp'
                        color: 0.4, 0.4, 0.4, 1
                        size_hint_y: None
                        height: self.texture_size[1]
                        halign: 'left'
                        text_size: self.width - dp(20), None
        
        # Información adicional
        Label:
            text: "Fiscalberry necesita estos permisos para:\\n• Conectar con impresoras Bluetooth\\n• Guardar configuración y logs\\n• Comunicarse con el servidor"
            font_size: '12sp'
            color: 0.4, 0.4, 0.4, 1
            size_hint_y: None
            height: dp(70)
            halign: 'center'
            text_size: self.width - dp(40), None
        
        Widget:
            size_hint_y: 0.1
        
        # Botones de acción
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(180)
            spacing: dp(10)
            
            # Botón principal - solicitar permisos o continuar
            Button:
                text: "Solicitar Permisos" if not root.permissions_granted else "Continuar"
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.6, 0.9, 1) if not root.permissions_granted else (0.2, 0.7, 0.3, 1)
                color: 1, 1, 1, 1
                font_size: '16sp'
                bold: True
                on_press: root.request_all_permissions() if not root.permissions_granted else root.continue_anyway()
            
            # Botón para abrir configuración (solo si faltan permisos)
            Button:
                text: "Abrir Configuración de App"
                size_hint_y: None
                height: dp(45) if not root.permissions_granted else 0
                opacity: 0 if root.permissions_granted else 1
                disabled: root.permissions_granted
                background_color: 0.5, 0.5, 0.7, 1
                color: 1, 1, 1, 1
                font_size: '14sp'
                on_press: root.open_app_settings()
            
            # Botón secundario - continuar sin permisos
            Button:
                text: "Continuar sin todos los permisos"
                size_hint_y: None
                height: dp(40) if not root.permissions_granted else 0
                opacity: 0 if root.permissions_granted else 1
                disabled: root.permissions_granted
                background_color: 0.7, 0.7, 0.7, 1
                color: 0.3, 0.3, 0.3, 1
                font_size: '12sp'
                on_press: root.continue_anyway()
            
            Label:
                text: "(Algunas funciones pueden no estar disponibles)" if not root.permissions_granted else ""
                font_size: '10sp'
                italic: True
                color: 0.6, 0.6, 0.6, 1
                size_hint_y: None
                height: dp(20) if not root.permissions_granted else 0
                opacity: 0 if root.permissions_granted else 1
