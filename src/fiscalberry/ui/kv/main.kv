# ============================================
# ARCHIVO: src/fiscalberry/ui/kv/main.kv
# ============================================
ScreenManager:
    LoginScreen:
        name: "login"
    MainScreen:
        name: "main"
    LogScreen:
        name: "logs"
    AdoptScreen:
        name: "adopt"

<AdoptScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(30)
        spacing: dp(20)
        canvas.before:
            Color:
                rgba: 0.98, 0.98, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header con logo
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(140)
            spacing: dp(15)
            
            Image:
                source: app.logo_image
                size_hint_y: None
                height: dp(80)
                allow_stretch: True
                keep_ratio: True
            
            Label:
                text: "Vincular Dispositivo"
                font_size: sp(24)
                bold: True
                color: 0.2, 0.2, 0.2, 1
                size_hint_y: None
                height: dp(40)
        
        Widget:
            size_hint_y: 0.3
        
        # Contenedor del QR
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(280)
            spacing: dp(15)
            padding: dp(20)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [15]
            
            Label:
                text: "Escanea el código QR"
                font_size: sp(16)
                color: 0.4, 0.4, 0.4, 1
                size_hint_y: None
                height: dp(30)
            
            AsyncImage:
                source: root.qrCodeLink
                size_hint: None, None
                size: dp(200), dp(200)
                pos_hint: {'center_x': 0.5}
                allow_stretch: True
                keep_ratio: True
        
        Widget:
            size_hint_y: 0.2
        
        # Botón para abrir en navegador
        Button:
            text: "Abrir vinculación"
            size_hint_y: None
            height: dp(50)
            background_normal: ''
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: 0.2, 0.5, 0.9, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [25]
            font_size: sp(16)
            color: 1, 1, 1, 1
            on_press: import webbrowser; webbrowser.open(root.adoptarLink)
        
        Widget:
            size_hint_y: 0.5

<LoginScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(30)
        spacing: dp(20)
        canvas.before:
            Color:
                rgba: 0.98, 0.98, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        Widget:
            size_hint_y: 0.2
        
        Image:
            source: app.logo_image
            size_hint_y: None
            height: dp(80)
            allow_stretch: True
            keep_ratio: True
        
        Label:
            text: "Iniciar Sesión"
            font_size: sp(26)
            bold: True
            color: 0.2, 0.2, 0.2, 1
            size_hint_y: None
            height: dp(40)
        
        Label:
            text: root.errorMsg
            color: 0.9, 0.2, 0.2, 1
            font_size: sp(14)
            size_hint_y: None
            height: dp(30)
        
        Widget:
            size_hint_y: 0.1
        
        TextInput:
            id: username
            hint_text: "Usuario"
            multiline: False
            size_hint_y: None
            height: dp(50)
            padding: [dp(15), dp(15)]
            font_size: sp(16)
            background_normal: ''
            background_color: 1, 1, 1, 1
            foreground_color: 0.2, 0.2, 0.2, 1
            canvas.before:
                Color:
                    rgba: 0.9, 0.9, 0.9, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10]
            on_text_validate: password.focus = True
        
        TextInput:
            id: password
            hint_text: "Contraseña"
            password: True
            multiline: False
            size_hint_y: None
            height: dp(50)
            padding: [dp(15), dp(15)]
            font_size: sp(16)
            background_normal: ''
            background_color: 1, 1, 1, 1
            foreground_color: 0.2, 0.2, 0.2, 1
            canvas.before:
                Color:
                    rgba: 0.9, 0.9, 0.9, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10]
            on_text_validate: root.login(username.text, password.text)
        
        Button:
            text: "Iniciar Sesión"
            size_hint_y: None
            height: dp(50)
            background_normal: ''
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: 0.2, 0.5, 0.9, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [25]
            font_size: sp(16)
            bold: True
            color: 1, 1, 1, 1
            on_press: root.login(username.text, password.text)
        
        Widget:
            size_hint_y: 0.4

<Separator@Widget>:
    size_hint_y: None
    height: dp(1)
    canvas:
        Color:
            rgba: 0.9, 0.9, 0.9, 1
        Rectangle:
            pos: self.pos
            size: self.size

<MainScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        canvas.before:
            Color:
                rgba: 0.98, 0.98, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header con ícono de diccionario
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(60)
            spacing: dp(10)
            
            Image:
                source: app.logo_image
                size_hint: None, None
                size: dp(50), dp(50)
                allow_stretch: True
                keep_ratio: True
            
            Label:
                text: "Servidor de Impresión"
                font_size: sp(20)
                bold: True
                color: 0.2, 0.2, 0.2, 1
                halign: 'left'
                valign: 'middle'
                text_size: self.size
            
            # Botón minimalista solo con ícono de libro
            Button:
                size_hint: None, None
                size: dp(30), dp(30)
                background_normal: "fiscalberry/ui/assets/book.png"
                background_down: "fiscalberry/ui/assets/book.png"
                background_color: 1, 1, 1, 1
                border: (0, 0, 0, 0)
                on_press: import webbrowser; webbrowser.open("http://doc.paxapos.com/")
        
        Separator:
        
        # Información del comercio
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(100)
            spacing: dp(5)
            padding: dp(15)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10]
            
            Label:
                text: f"Comercio: {app.siteName if app.siteName else 'No configurado'}"
                font_size: sp(16)
                bold: True
                color: 0.2, 0.2, 0.2, 1
                halign: 'left'
                valign: 'middle'
                text_size: self.width, None
                size_hint_y: None
                height: dp(25)
            
            Label:
                text: f"Dispositivo: {app.siteAlias if app.siteAlias else 'No configurado'}"
                font_size: sp(14)
                color: 0.4, 0.4, 0.4, 1
                halign: 'left'
                valign: 'middle'
                text_size: self.width, None
                size_hint_y: None
                height: dp(22)
            
            Label:
                text: f"Ubicación: {app.printLocation if app.printLocation else 'No especificada'}"
                font_size: sp(14)
                color: 0.4, 0.4, 0.4, 1
                halign: 'left'
                valign: 'middle'
                text_size: self.width, None
                size_hint_y: None
                height: dp(22)
        
        # Información de impresión
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(80)
            spacing: dp(5)
            padding: dp(15)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10]
            
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(25)
                
                Label:
                    text: "Última Impresión:"
                    font_size: sp(14)
                    color: 0.4, 0.4, 0.4, 1
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.width, None
                    size_hint_x: 0.5
                
                Label:
                    text: app.lastPrintTime if app.lastPrintTime else "N/A"
                    font_size: sp(14)
                    color: 0.2, 0.2, 0.2, 1
                    halign: 'right'
                    valign: 'middle'
                    text_size: self.width, None
                    size_hint_x: 0.5
            
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(25)
                
                Label:
                    text: "Impresiones en Cola:"
                    font_size: sp(14)
                    color: 0.4, 0.4, 0.4, 1
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.width, None
                    size_hint_x: 0.5
                
                Label:
                    text: str(app.queueCount)
                    font_size: sp(14)
                    bold: True
                    color: 0.2, 0.2, 0.2, 1
                    halign: 'right'
                    valign: 'middle'
                    text_size: self.width, None
                    size_hint_x: 0.5
        
        # Botón de logs
        Button:
            text: "Ver Logs de Impresión"
            size_hint_y: None
            height: dp(50)
            background_normal: ''
            background_color: 0, 0, 0, 0
            canvas.before:
                Color:
                    rgba: 0.3, 0.3, 0.3, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [25]
            font_size: sp(14)
            color: 1, 1, 1, 1
            on_press: app.root.current = "logs"
        
        Widget:
        
        # Footer
        Label:
            text: f"UUID: {app.uuid[:8]}... | v{app.version} | {app.host}"
            font_size: sp(10)
            color: 0.6, 0.6, 0.6, 1
            size_hint_y: None
            height: dp(20)

<LogScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(10)
        canvas.before:
            Color:
                rgba: 0.98, 0.98, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(50)
            spacing: dp(10)
            
            # Botón minimalista de volver
            Button:
                text: "Volver"
                size_hint: None, None
                size: dp(100), dp(40)
                background_normal: ''
                background_color: 0, 0, 0, 0
                font_size: sp(14)
                color: 0.4, 0.4, 0.4, 1
                on_press: app.root.current = "main"
            
            Label:
                text: "Logs de Impresión"
                font_size: sp(20)
                bold: True
                color: 0.2, 0.2, 0.2, 1
                halign: 'left'
                valign: 'middle'
                text_size: self.width, None
        
        # Área de logs
        BoxLayout:
            orientation: 'vertical'
            padding: dp(15)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [10]
            
            ScrollView:
                id: scroll_view
                
                TextInput:
                    id: log_output
                    text: root.logs
                    readonly: True
                    font_size: sp(12)
                    background_color: 0.95, 0.95, 0.95, 1
                    foreground_color: 0.2, 0.2, 0.2, 1
                    size_hint_y: None
                    height: max(self.minimum_height, scroll_view.height)
                    multiline: True
                    padding: [dp(10), dp(10)]