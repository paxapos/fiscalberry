ScreenManager:
    LoginScreen:
        name: "login"
    MainScreen:
        name: "main"
    LogScreen: # Add LogScreen here
        name: "logs" # Give it a name for navigation

<AdoptScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        canvas.before:
            Color:
                rgba: 0.95, 0.95, 1, 1  # Fondo celeste claro
            Rectangle:
                pos: self.pos
                size: self.size

        # Logo y t铆tulo
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(120)
            spacing: dp(10)
            
            Image:
                source: app.logo_image
                size_hint_y: None
                height: dp(60)
                allow_stretch: True
                keep_ratio: True
                
            Label:
                text: "Vincula tu dispositivo con Paxapos"
                font_size: '18sp'
                bold: True
                color: 0.1, 0.2, 0.5, 1
                size_hint_y: None
                height: dp(40)
                halign: 'center'
        
        # Contenido principal
        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(40)
            size_hint_y: None
            height: dp(280)
            
            # Lado izquierdo - Bot贸n
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.5
                spacing: dp(15)
                
                Label:
                    text: "Usar navegador"
                    font_size: '16sp'
                    bold: True
                    color: 0.2, 0.2, 0.2, 1
                    size_hint_y: None
                    height: dp(30)
                    halign: 'center'
                
                Button:
                    text: "Abrir vinculaci贸n"
                    size_hint_y: None
                    height: dp(60)
                    background_color: 0.2, 0.4, 0.8, 1
                    color: 1, 1, 1, 1
                    font_size: '15sp'
                    on_press: import webbrowser; webbrowser.open(root.adoptarLink)
                
                Label:
                    text: "Se abrir谩 la p谩gina\nde vinculaci贸n"
                    font_size: '12sp'
                    color: 0.5, 0.5, 0.5, 1
                    size_hint_y: None
                    height: dp(40)
                    halign: 'center'
                    text_size: self.width, None
                
                Widget:
            
            # Lado derecho - QR
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.5
                spacing: dp(15)
                
                Label:
                    text: "Escanear QR"
                    font_size: '16sp'
                    bold: True
                    color: 0.2, 0.2, 0.2, 1
                    size_hint_y: None
                    height: dp(30)
                    halign: 'center'
                
                # Contenedor del QR sin fondo
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: dp(180)
                    
                    AsyncImage:
                        source: root.qrCodeLink
                        size_hint: None, None
                        size: dp(160), dp(160)
                        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                        allow_stretch: True
                        keep_ratio: True
                        
                    # Loading fallback
                    Label:
                        text: " Cargando QR..."
                        font_size: '14sp'
                        color: 0.6, 0.6, 0.6, 1
                        halign: 'center'
                        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                        opacity: 0
                
                Label:
                    text: "Escanea con tu celular"
                    font_size: '12sp'
                    color: 0.5, 0.5, 0.5, 1
                    size_hint_y: None
                    height: dp(20)
                    halign: 'center'
                
                Widget:
        
        # Texto explicativo
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(90)
            spacing: dp(10)
            padding: [dp(20), 0]
            
            Label:
                text: "驴Qu茅 es esto?"
                font_size: '14sp'
                bold: True
                color: 0.2, 0.2, 0.2, 1
                size_hint_y: None
                height: dp(25)
                halign: 'center'
            
            Label:
                text: "Esta vinculaci贸n conecta y habilita el servicio de impresi贸n (Paxaprinter)\ncon tu comercio, permitiendo imprimir tickets y facturas autom谩ticamente\ndesde el sistema Paxapos."
                font_size: '12sp'
                color: 0.4, 0.4, 0.4, 1
                size_hint_y: None
                height: dp(55)
                halign: 'center'
                text_size: self.width - dp(40), None
                valign: 'middle'
        
        # Espaciador flexible
        Widget:

<LoginScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 15
        canvas.before:
            Color:
                rgba: 0.9, 0.9, 1, 1  # Fondo celeste casi blanco
            Rectangle:
                pos: self.pos
                size: self.size

        Image:
            source: app.logo_image
            size_hint_y: None
            height: 96
            allow_stretch: True
            keep_ratio: True
            color: 1, 1, 1, 1
            margin_bottom: 10


        Label:
            text: "Iniciar Sesi贸n"
            font_size: 24
            color: 0.1, 0.2, 0.5, 1  # Azul oscuro

        Label:
            text: "Utilice su usuario y contrase帽a para acceder al sistema."
            size_hint_y: None
            height: 30
            halign: "center"
            valign: "middle"
            text_size: self.size
            color: 0.5, 0.5, 0.5, 1  # Gris tenue

        Label:
            text: root.errorMsg
            color: 0.8, 0.2, 0.2, 1  # Rojo est谩ndar para errores
            font_size: 16
            size_hint_y: None
            height: 30
            halign: "center"
            valign: "middle"
            text_size: self.size

        TextInput:
            id: username
            hint_text: "Usuario"
            multiline: False
            size_hint_y: None
            height: 50
            background_color: 1, 1, 1, 1
            foreground_color: 0, 0, 0, 1
            padding: [10, 10]
            on_text_validate: password.focus = True  # Al presionar Enter, enfocar el siguiente input
        TextInput:
            id: password
            hint_text: "Contrase帽a"
            password: True
            multiline: False
            size_hint_y: None
            height: 50
            background_color: 1, 1, 1, 1
            foreground_color: 0, 0, 0, 1
            padding: [10, 10]
            on_text_validate: root.login(username.text, password.text)  # Al presionar Enter, ejecutar login
        Button:
            text: "Login"
            size_hint_y: None
            height: 50
            background_color: 0.1, 0.2, 0.5, 1  # Azul oscuro
            color: 1, 1, 1, 1
            on_press: root.login(username.text, password.text)

# Define a reusable Separator widget
<Separator@Widget>:
    canvas:
        Color:
            rgba: 0.8, 0.8, 0.8, 1 # Light gray color for separator
        Rectangle:
            pos: self.x, self.center_y - dp(0.5) # Center the line vertically
            size: self.width, dp(1) # Make it 1dp thick

<MainScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(25)
        spacing: dp(20)
        canvas.before:
            Color:
                rgba: 0.96, 0.96, 1, 1 # Fondo m谩s claro y limpio
            Rectangle:
                pos: self.pos
                size: self.size

        # Header mejorado con mejor dise帽o
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(60)
            spacing: dp(15)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 0.8 # Fondo blanco semi-transparente
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(10)]
            padding: dp(15)
            
            Image:
                source: app.logo_image
                size_hint: None, None
                size: dp(40), dp(40)
                allow_stretch: True
                keep_ratio: True
                
            Label:
                text: "Fiscalberry - Servidor de Impresi贸n"
                font_size: '18sp'
                bold: True
                halign: 'left'
                valign: 'middle'
                color: 0.1, 0.2, 0.5, 1
                size_hint_x: 1
                
            # Estado visual grande en header
            Label:
                text: "[CONECTADO]" if app.sioConnected else "[DESCONECTADO]"
                font_size: '14sp'
                bold: True
                color: (0.1, 0.7, 0.1, 1) if app.sioConnected else (0.8, 0.1, 0.1, 1)
                halign: 'right'
                valign: 'middle'
                size_hint: None, None
                size: dp(130), dp(40)

        # Panel de estado principal con dise帽o atractivo
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(140)
            spacing: dp(15)
            canvas.before:
                Color:
                    rgba: (0.9, 1, 0.9, 1) if app.sioConnected else (1, 0.95, 0.95, 1)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(15)]
                Color:
                    rgba: (0.7, 0.9, 0.7, 1) if app.sioConnected else (0.9, 0.7, 0.7, 1)
                Line:
                    rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], dp(15))
                    width: 2
            padding: dp(20)

            Label:
                text: "ESTADO DE CONEXIN"
                font_size: '16sp'
                bold: True
                color: 0.2, 0.2, 0.2, 1
                size_hint_y: None
                height: dp(25)
                halign: 'center'

            # Estado simplificado solo nube
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: None
                height: dp(35)
                spacing: dp(15)
                
                # Solo estado de nube (conexi贸n principal)
                BoxLayout:
                    orientation: 'horizontal'
                    spacing: dp(12)
                    
                    Label:
                        text: "[OK]" if app.sioConnected else "[ERROR]"
                        font_size: '16sp'
                        bold: True
                        color: (0.2, 0.7, 0.2, 1) if app.sioConnected else (0.8, 0.2, 0.2, 1)
                        size_hint: None, None
                        size: dp(60), dp(30)
                        halign: 'center'
                        valign: 'middle'
                        
                    Label:
                        text: "Servidor Paxapos: " + ("CONECTADO" if app.sioConnected else "DESCONECTADO")
                        color: (0.2, 0.7, 0.2, 1) if app.sioConnected else (0.8, 0.2, 0.2, 1)
                        font_size: '15sp'
                        bold: True
                        halign: 'center'
                        valign: 'middle'

            # Mensaje de estado amigable
            Label:
                text: "Todo funcionando correctamente - Listo para imprimir" if app.sioConnected else "Sin conexi贸n - Verifica tu internet y configuraci贸n"
                font_size: '14sp'
                color: (0.1, 0.6, 0.1, 1) if app.sioConnected else (0.7, 0.4, 0.1, 1)
                size_hint_y: None
                height: dp(30)
                halign: 'center'
                text_size: self.width - dp(40), None
                valign: 'middle'

        # Panel de informaci贸n del comercio mejorado
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(100)
            spacing: dp(10)
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 0.9
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(10)]
                Color:
                    rgba: 0.8, 0.8, 0.9, 1
                Line:
                    rounded_rectangle: (self.pos[0], self.pos[1], self.size[0], self.size[1], dp(10))
                    width: 1
            padding: dp(15)

            Label:
                text: "INFORMACIN DEL COMERCIO"
                font_size: '14sp'
                bold: True
                color: 0.1, 0.2, 0.5, 1
                size_hint_y: None
                height: dp(20)
                halign: 'center'

            BoxLayout:
                orientation: 'horizontal'
                spacing: dp(20)
                
                Label:
                    text: f"Comercio: {app.siteName or 'No configurado'}"
                    font_size: '13sp'
                    color: 0.3, 0.3, 0.3, 1
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.width, None
                    size_hint_x: 0.6

                Label:
                    text: f"Dispositivo: {app.siteAlias or 'Sin alias'}"
                    font_size: '13sp'
                    color: 0.3, 0.3, 0.3, 1
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.width, None
                    size_hint_x: 0.4

        # Espaciador
        Widget:

        # Bot贸n de logs mejorado
        Button:
            text: "Ver Registro de Actividad del Servicio"
            size_hint_y: None
            height: dp(55)
            background_color: 0.1, 0.3, 0.6, 1
            color: 1, 1, 1, 1
            font_size: '15sp'
            bold: True
            canvas.before:
                Color:
                    rgba: 0.1, 0.3, 0.6, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(8)]
            on_press: app.root.current = "logs"

        # Bot贸n de reiniciar servicio
        Button:
            text: "Reiniciar Servicio"
            size_hint_y: None
            height: dp(55)
            background_color: 0.8, 0.4, 0.1, 1
            color: 1, 1, 1, 1
            font_size: '15sp'
            bold: True
            canvas.before:
                Color:
                    rgba: 0.8, 0.4, 0.1, 1
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(8)]
            on_press: app.restart_service()

        # Footer mejorado
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(25)
            spacing: dp(15)
            canvas.before:
                Color:
                    rgba: 0.9, 0.9, 0.9, 0.7
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(5)]
            padding: dp(10)
            
            Label:
                text: f"ID: {app.uuid[:8] if app.uuid else 'No ID'}"
                font_size: '10sp'
                color: 0.4, 0.4, 0.4, 1
                halign: "left"
                valign: "middle"
                size_hint_x: 0.35
                
            Label:
                text: f"v{app.version if app.version else '1.0'}"
                font_size: '10sp'
                color: 0.4, 0.4, 0.4, 1
                halign: "center"
                valign: "middle"
                size_hint_x: 0.3
                
            Label:
                text: f"{app.host if app.host else 'Paxapos'}"
                font_size: '10sp'
                color: 0.4, 0.4, 0.4, 1
                halign: "right"
                valign: "middle"
                size_hint_x: 0.35
            
<LogScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10

        Label:
            text: "Logs del Servicio"
            font_size: 24
            size_hint_y: None
            height: 50
        
        Button:
            text: root.logFilePath
            font_size: 12
            size_hint_y: None
            height: self.texture_size[1] + dp(10) # Adjust height based on text
            # Style to look like a clickable link
            background_color: 0, 0, 0, 0 # Transparent background
            color: 0.1, 0.2, 0.8, 1 # Blue color like a hyperlink
            # Action to open the file using a method defined in the Python class
            # Ensure 'open_log_file' method exists in your LogScreen Python class
            on_press: root.open_log_file()

        ScrollView:
            id: scroll_view  # Agregar un ID para acceder desde Python
            size_hint: (1, 1)
            TextInput:
                id: log_output
                text: root.logs
                readonly: True
                font_size: 14
                background_color: 0, 0, 0, 1  # Fondo negro
                foreground_color: 1, 1, 1, 1  # Texto blanco
                size_hint_y: None
                height: self.minimum_height
                multiline: True

        Button:
            text: "Volver"
            size_hint_y: None
            height: 50
            on_press: app.root.current = "main"